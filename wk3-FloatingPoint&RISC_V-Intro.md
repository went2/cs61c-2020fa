# 第三周 浮点数、RISC-V 入门

## Lecture 06.1 Basics & Fixed Point

有 6 个 bits 用来表示浮点数，且规定二进制的小数点在从左往右的第二位，二进制 0 表示为即 `00.0000`。
而 `11.1111` 表示十进制的 3.9375 (3+15/16)。

那么 6 bits 能表示的小数范围为 `[0 - 3.9375]`。如果不规定这个小数点，6 bits 能表示的无符号整数范围为 `[0-63]`。

上述表示小数的前提是，要实现规定二进制的小数点在某个位置。那么能否在给定一个二进制数的同时，再传入一个小数点的位数，来确定它对应的小数大小？这样小数点就不是 fixed，而是 floating。

## Lecture 06.2 - Floating Point: Floating Point

假设要把 0.1640625 以二进制表示，用 5个bits 表示其 energy，再选择把二进制小数点放在哪里。

`...000000.001010100000...`

浮点数存的是 `10101` 这个 energy 部分，以及二进制小数点的位置：位于 energy 的 MSB 左边的两位。

在浮点数表示下，每个数都带一个 exponent 字段来记录它的二进制小数点放在哪里。类似十进制，当一个数乘以 10 的1次，小数点右移1位，右边补个0，这个数变为10倍；乘以10^(-2)，小数点左移两位，左边要补两个0，这个数缩小了100倍。

只不过 exponent 是基于 2 进行扩大缩小，小数点右移1位，整个数变为2倍；左移1位，变为 1/2。

浮点数的标准格式：`+1.xxx...x * 2^(yyy...y)`，注意，二进制小数点左边的永远都是 1。

其中，`+` 是符号位， `xxx...x` 小数点部分叫 significand(有效数), `yyy...y` 指数部分就是 exponent。由于小数点左边永远是1，这是约定所以不用保存这个1。用一个 32 位的 word size 保存一个浮点数：
  - 符号位占1位，最左边的那位
  - exponent占8位，符号位的后8位
  - significand占23位，符号位后的23位。

注，浮点数中的符号位用的是 `sign magnitude` 表示，0表示整个浮点数是正数，1表示负数。不是整型用的2补数表示。

不看exponent的情况下, 有效数表示的数值是：
  - `100000...0`: 1后面全部零，表示二进制的 `1.100000...0`，表示十进制的 1.5
  - `00000...1`: 前面全是0，最后一位是1，表示二进制的 `1.00000...1`，表示十进制的 `1+2^(-23)`
即在标准的科学计数法下，单独的有效数永远 >0 且 <1，在算数值的时候要把省略的1加上去。如果有效数全是0，表示整个数是0

8 位exponent也有正负表示，IEEE 754 用的是`biased notation` 表示法，单精度的 bias 是127，即8位能表示的数([0,255])减去127，得到最终的取值范围[-127,...0...,128]。具体算法是：

`(-1)^s × (1 + significand) × 2^(exponent-127)`, s 是符号位，要么1，要么0

双精度浮点数的算法相同，只不过它的 bias 是 1023

溢出问题：
  - 对于 >3.4×10^38, <-3.4×10^38 的数，就会溢出8位的exponent，即大于两端的值会出现溢出
  - 对于 >0 且 <1.2×10^(-38), <0 且 > -1.2×10^(-38) 的，也会溢出8位的exponent，即无限接近0的值也会有溢出

能否解决溢出问题？无法从根本解决，但可以减少，比如提高 significand 的位数，从单精度的 1+23bits 提高到双精度的 1+52bits。

## Lecture 06.3 - Floating Point: Special Numbers

浮点数表示概括来说，保存一个 significand 作为有效数，保存一个 exponent，在有效数的基础上 ×2 或者 ÷2，保存符号位区分正负，通过计算公式：`(-1)^s × (1 + significand) × 2^(exponent-127)`，得到最终结果。

实际上有效数和指数有如下几种组合类型：

| exponent | significand | Object  | 
|---|---|---|
| 0 | 0 | 0 |
| 0 |  非零值 | ??? |
| 1-254 | 任何值 | 正常的正负浮点数值 |
| 255 | 0 | 正负无穷 |
| 255 | 非零值 | NaN |

上面提到的计算公式，适用于第三行的浮点数计算。

正负无穷数的表示：IEEE 754 中，只要越过边界，就得到正负无穷的值。
非数（NaN）的表示：非数指进行 sqrt(-4) 、0/0 等运算得到的结果，在数学上是错误，在计算机中是非数。IEEE 把指数为 255，有效数为非零数的组合，用来表示非数。
